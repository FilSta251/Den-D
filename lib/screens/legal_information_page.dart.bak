import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:easy_localization/easy_localization.dart';
import 'package:flutter_markdown/flutter_markdown.dart';
import '../utils/constants.dart';

class LegalInformationPage extends StatefulWidget {
  final String contentType;

  const LegalInformationPage({
    super.key,
    required this.contentType,
  });

  @override
  State<LegalInformationPage> createState() => _LegalInformationPageState();
}

class _LegalInformationPageState extends State<LegalInformationPage> {
  String _content = '';
  bool _isLoading = true;
  String? _error;

  @override
  void initState() {
    super.initState();
    _loadContent();
  }

  /// Náčte obsah markdown souboru podle typu
  Future<void> _loadContent() async {
    try {
      setState(() {
        _isLoading = true;
        _error = null;
      });

      final String filePath = widget.contentType == 'privacy'
          ? LegalLinks.privacyPath
          : LegalLinks.termsPath;

      debugPrint('[LegalInformationPage] Náčítám soubor: $filePath');

      final String content = await rootBundle.loadString(filePath);

      setState(() {
        _content = content;
        _isLoading = false;
      });

      debugPrint('[LegalInformationPage] Obsah úspěĹˇně náčten');
    } catch (e) {
      debugPrint('[LegalInformationPage] Chyba při náčítání obsahu: $e');

      setState(() {
        _error = e.toString();
        _isLoading = false;
        _content = _getFallbackContent();
      });
    }
  }

  /// Vrací záloťní obsah pokud se nepodaří náčíst markdown
  String _getFallbackContent() {
    if (widget.contentType == 'privacy') {
      return '''
# Zásady ochrany osobních údajů

**Poslední aktualizace:** 01.08.2025

Tato aplikace **Svatební plánováč "“ Den D** (dále jen "žAplikace") chrání VaĹˇe soukromí a osobní údaje. Tyto zásady vysvětlují, jakĂ© údaje shromaťďŹujeme, jak je pouťíváme, jak je chráníme a jaká máte práva v souladu s Nařízením (EU) 2016/679 (GDPR).

## 1. Kdo je správcem osobních údajů

Správcem osobních údajů je:
**Filip Ĺ šastný**
E-mail: **app@stastnyfoto.com**

## 2. JakĂ© údaje shromaťďŹujeme

V rámci pouťívání Aplikace můťeme shromaťďŹovat:

* **Identifikáční údaje**: e-mailová adresa (pouze při registraci nebo přihláĹˇení).
* **TechnickĂ© údaje**: typ a verze zařízení, operáční systĂ©m, IP adresa.
* **Ăšdaje o pouťívání aplikace**: anonymní analytická data (např. četnost pouťívání funkcí aplikace).

**Poznámka:** Nezpracováváme citlivĂ© osobní údaje (např. rodná čísla, zdravotní údaje).

## 3. Jak údaje pouťíváme

VaĹˇe údaje pouťíváme k těmto účelům:

1. Poskytování sluťeb aplikace (např. ukládání poznámek a plánů svatby).
2. ZlepĹˇování funkcí a uťivatelskĂ©ho záťitku.
3. Poskytování technickĂ© podpory a řeĹˇení problĂ©mů.

## 4. Sdílení údajů

VaĹˇe osobní údaje **neprodáváme** a **nepředáváme třetím stranám** s výjimkou:

* **Technických poskytovatelů** (např. cloudovĂ© servery pro ukládání dat a analytickĂ© nástroje).
* **Státních orgánů**, pokud to vyťaduje zákon.

Se vĹˇemi poskytovateli máme uzavřeny smlouvy o zpracování dat dle GDPR.

## 5. Uchovávání údajů

VaĹˇe údaje uchováváme po dobu aktivního pouťívání aplikace. Pokud svůj účet smaťete, vĹˇechny osobní údaje budou nevratně vymazány do 30 dnů.

## 6. VaĹˇe práva

V souladu s GDPR máte právo:

* poťádat o přístup k osobním údajům,
* poťádat o opravu nebo výmaz,
* poťádat o omezení zpracování,
* vznĂ©st námitku proti zpracování,
* poťádat o přenositelnost údajů,
* podat stíťnost u Ăšřadu pro ochranu osobních údajů (ĂšOOĂš).

Svá práva můťete uplatnit zasláním e-mailu na: **app@stastnyfoto.com**

## 7. Bezpečnost údajů

Pouťíváme technická a organizáční opatření k ochraně VaĹˇich údajů před neoprávněným přístupem, ztrátou nebo zneuťitím.

## 8. Změny zásad

Tyto zásady můťeme aktualizovat. Nová verze bude vťdy k dispozici:

* v sekci "žO aplikaci" v Aplikaci
* na webových stránkách: **www.stastnyfoto.com**

---

**Kontakt pro otázky k ochraně osobních údajů:**
**Filip Ĺ šastný**
E-mail: **app@stastnyfoto.com**
      ''';
    } else {
      return '''
# Obchodní podmínky

**Poslední aktualizace:** 01.08.2025

## Poskytovatel sluťby

**Filip Ĺ šastný**
E-mail: **app@stastnyfoto.com**
Web: **www.stastnyfoto.com**

## Sluťby

Svatební plánováč "“ Den D - mobilní aplikace pro plánování svatby.

### Free verze
- Omezená na **3 interakce denně**
- Základní funkce aplikace

### Premium předplatnĂ©
- **Cena: 200 Kč/rok včetně DPH**
- Neomezený přístup ke vĹˇem funkcím
- **AutomatickĂ© obnovení** kaťdý rok
- ZruĹˇení kdykoliv v Google Play Store

## Platby a předplatnĂ©

- Platby zpracovává **Google Play Store**
- PodporovanĂ© platební metody dle Google Play
- **AutomatickĂ© obnovení** 24 hodin před expirací
- PředplatnĂ© se účtuje k datu nákupu a potĂ© kaťdoročně

## ZruĹˇení předplatnĂ©ho

PředplatnĂ© zruĹˇíte v Google Play Store:

1. Otevřete Google Play Store
2. Přejděte na **Moje aplikace a hry**
3. Vyberte **Předplatná**
4. Najděte **Svatební plánováč "“ Den D** a zruĹˇte

**Pozor:** ZruĹˇení předplatnĂ©ho neznamená vrácení peněz za aktuální období.

## Právo na odstoupení

Máte právo odstoupit od smlouvy do **14 dnů** bez udání důvodu.

**Výjimka:** Při okamťitĂ©m pouťívání sluťby (staťení a aktivní pouťívání aplikace) toto právo zaniká v souladu s § 1837 písm. l) občanskĂ©ho zákoníku.

## OdpovědĐ˝ĐľŃŃ‚ŃŚ a omezení záruky

- Sluťba je poskytována "žtak jak je"
- Neneseme odpovědnost za Ĺˇkody způsobenĂ© nesprávným uťíváním aplikace
- Neručíme za nepřeruĹˇovaný provoz aplikace
- Doporučujeme pravidelnĂ© zálohování důleťitých dat

## Reklamace a technická podpora

Reklamace a dotazy podávejte na: **app@stastnyfoto.com**

- Odpovídáme do **48 hodin**
- Reklamace vyřizujeme do **30 dnů**

## DuĹˇevní vlastnictví

VeĹˇkerý obsah aplikace (design, texty, ikony) je chráněn autorským právem a je vlastnictvím poskytovatele.

## Závěrečná ustanovení

- Tyto podmínky se řídí **českým právem**
- Při sporech je přísluĹˇný **Okresní soud v Brně**
- Pokud je některĂ© ustanovení neplatnĂ©, ostatní zůstávají v platnosti

---

**Kontakt:**
**Filip Ĺ šastný**
E-mail: **app@stastnyfoto.com**
Web: **www.stastnyfoto.com**

Podmínky platnĂ© od **01.08.2025**
      ''';
    }
  }

  /// Vrací název stránky podle typu obsahu
  String _getPageTitle() {
    switch (widget.contentType) {
      case 'privacy':
        return tr('legal.privacy.title');
      case 'terms':
      default:
        return tr('legal.terms.title');
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text(_getPageTitle()),
        backgroundColor: Theme.of(context).primaryColor,
        foregroundColor: Colors.white,
        elevation: 0,
      ),
      body: _isLoading
          ? const Center(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  CircularProgressIndicator(),
                  SizedBox(height: 16),
                  Text('Náčítání právních informací...'),
                ],
              ),
            )
          : _error != null
              ? Center(
                  child: Padding(
                    padding: const EdgeInsets.all(16.0),
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(
                          Icons.error_outline,
                          size: 64,
                          color: Colors.red[300],
                        ),
                        const SizedBox(height: 16),
                        Text(
                          tr('legal.error.title'),
                          style: Theme.of(context).textTheme.headlineSmall,
                          textAlign: TextAlign.center,
                        ),
                        const SizedBox(height: 8),
                        Text(
                          tr('legal.error.message'),
                          style: Theme.of(context).textTheme.bodyMedium,
                          textAlign: TextAlign.center,
                        ),
                        const SizedBox(height: 16),
                        ElevatedButton.icon(
                          onPressed: _loadContent,
                          icon: const Icon(Icons.refresh),
                          label: Text(tr('legal.error.retry')),
                        ),
                        const SizedBox(height: 8),
                        Text(
                          'Debug: $_error',
                          style:
                              Theme.of(context).textTheme.bodySmall?.copyWith(
                                    color: Colors.grey[600],
                                  ),
                          textAlign: TextAlign.center,
                        ),
                      ],
                    ),
                  ),
                )
              : Column(
                  children: [
                    // Header s informací o typu obsahu
                    Container(
                      width: double.infinity,
                      padding: const EdgeInsets.all(16.0),
                      color: Theme.of(context).primaryColor.withOpacity(0.1),
                      child: Row(
                        children: [
                          Icon(
                            widget.contentType == 'privacy'
                                ? Icons.privacy_tip_outlined
                                : Icons.description_outlined,
                            color: Theme.of(context).primaryColor,
                          ),
                          const SizedBox(width: 12),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  _getPageTitle(),
                                  style: Theme.of(context)
                                      .textTheme
                                      .titleMedium
                                      ?.copyWith(
                                        fontWeight: FontWeight.bold,
                                      ),
                                ),
                                const SizedBox(height: 4),
                                Text(
                                  widget.contentType == 'privacy'
                                      ? 'Ochrana osobních údajů dle GDPR'
                                      : 'Podmínky pouťívání aplikace',
                                  style: Theme.of(context).textTheme.bodySmall,
                                ),
                              ],
                            ),
                          ),
                        ],
                      ),
                    ),

                    // Markdown obsah
                    Expanded(
                      child: Markdown(
                        data: _content,
                        selectable: true,
                        styleSheet: MarkdownStyleSheet(
                          p: Theme.of(context).textTheme.bodyMedium,
                          h1: Theme.of(context)
                              .textTheme
                              .headlineMedium
                              ?.copyWith(
                                fontWeight: FontWeight.bold,
                                color: Theme.of(context).primaryColor,
                              ),
                          h2: Theme.of(context)
                              .textTheme
                              .headlineSmall
                              ?.copyWith(
                                fontWeight: FontWeight.bold,
                                color: Theme.of(context).primaryColor,
                              ),
                          h3: Theme.of(context).textTheme.titleLarge?.copyWith(
                                fontWeight: FontWeight.bold,
                              ),
                          blockquote:
                              Theme.of(context).textTheme.bodyMedium?.copyWith(
                                    fontStyle: FontStyle.italic,
                                    color: Colors.grey[700],
                                  ),
                          code: TextStyle(
                            fontFamily: 'monospace',
                            backgroundColor: Colors.grey[100],
                          ),
                          codeblockDecoration: BoxDecoration(
                            color: Colors.grey[100],
                            borderRadius: BorderRadius.circular(4),
                          ),
                        ),
                        onTapLink: (text, href, title) {
                          debugPrint(
                              '[LegalInformationPage] Kliknuto na odkaz: $href');
                        },
                      ),
                    ),
                  ],
                ),

      // Dolní liĹˇta s rychlými odkazy
      bottomNavigationBar: Container(
        padding: const EdgeInsets.all(16.0),
        decoration: BoxDecoration(
          color: Theme.of(context).scaffoldBackgroundColor,
          border: Border(
            top: BorderSide(
              color: Colors.grey[300]!,
              width: 1,
            ),
          ),
        ),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.spaceEvenly,
          children: [
            if (widget.contentType != 'terms')
              TextButton.icon(
                onPressed: () {
                  Navigator.of(context).pushReplacementNamed(
                    '/legal',
                    arguments: 'terms',
                  );
                },
                icon: const Icon(Icons.description_outlined),
                label: const Text('Podmínky'),
              ),
            if (widget.contentType != 'privacy')
              TextButton.icon(
                onPressed: () {
                  Navigator.of(context).pushReplacementNamed(
                    '/legal',
                    arguments: 'privacy',
                  );
                },
                icon: const Icon(Icons.privacy_tip_outlined),
                label: const Text('Soukromí'),
              ),
          ],
        ),
      ),
    );
  }
}
